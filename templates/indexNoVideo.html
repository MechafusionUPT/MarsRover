<!doctype html>
<html lang="ro">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rover Controller</title>
    <style>
        body {
            background: #112;
            color: #ddd;
            font-family: sans-serif;
            margin: 0;
            padding: 1rem;
        }

        h1 {
            color: #0f0;
            margin: 0 0 .5rem;
        }

        .card {
            background: #1b1b1b;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1rem;
            max-width: 680px; /* încape lejer pe jumătate de ecran */
            margin-bottom: 1rem;
        }

        .val {
            font: 14px monospace;
            margin-top: .5rem;
        }

        .ok {
            color: #0f0;
        }

        .err {
            color: #f33;
        }

        #arrow {
            font-size: 72px;
            text-align: center;
            transform-origin: center;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <h1>Rover Controller</h1>

    <div class="card">
        <div id="status">status: <span class="err">deconectat</span></div>
        <div id="gamepad-status">controller: <span class="err">neconectat</span></div>

        <!-- valori numerice de control -->
        <div class="val" id="vals">vx=0.00 vy=0.00 sx=0.00 grip=0</div>

        <!-- săgeata de direcție -->
        <div id="arrow">↑</div>

        <!-- telemetrie senzori -->
        <div class="val" id="telemetry">temp=– hum=–</div>

        <!-- ultimul cod QR citit -->
        <div class="val">Ultimul QR: <span id="qrText">–</span></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // ----- Socket.IO -----
        const socket = io({ transports: ['websocket'] });
        const statusEl = document.getElementById("status");
        const gpStatusEl = document.getElementById("gamepad-status");
        const valsEl = document.getElementById("vals");
        const arrowEl = document.getElementById("arrow");
        const telemEl = document.getElementById("telemetry");
        const qrTextEl = document.getElementById("qrText");

        socket.on("connect", () => {
            statusEl.innerHTML = 'status: <span class="ok">conectat</span>';
        });

        socket.on("disconnect", () => {
            statusEl.innerHTML = 'status: <span class="err">deconectat</span>';
        });

        socket.on("telemetry.sensors", d => {
            telemEl.textContent = `temp=${d.temp?.toFixed?.(1) ?? d.temp} hum=${d.hum?.toFixed?.(1) ?? d.hum}`;
        });

        // textul QR vine de la worker-ul de QR din backend
        socket.on("qr.detected", d => {
            if (d && d.text && qrTextEl) {
                qrTextEl.textContent = d.text;
            }
        });

        function nearly(a, b, eps = EPS) { return Math.abs(a - b) < eps; }

        // ----- Gamepad -----
        let gpIndex = null;
        let vx = 0, vy = 0, sx = 0, grip = 0, pitch = 0;
        const DEADZONE = 0.15;
        const EPS = 0.01;
        let last = { vx: 0, vy: 0, sx: 0, grip: 0, pitch: 0 };
        let lastSend = 0;

        const dz = x =>
            Math.abs(x) < DEADZONE
                ? 0
                : (x - Math.sign(x) * DEADZONE) / (1 - DEADZONE);

        const clamp = (x, a = -1, b = 1) => Math.max(a, Math.min(b, x));

        const expo = (x, k = 1.3) => {
            const s = Math.sign(x);
            x = Math.abs(x);
            return s * Math.pow(x, k);
        };

        function sendThrottled() {
            const now = performance.now();
            const changed = !(
                nearly(vx, last.vx) &&
                nearly(vy, last.vy) &&
                nearly(sx, last.sx) &&
                nearly(grip, last.grip) &&
                nearly(pitch, last.pitch)
            );
            if (!changed && (now - lastSend) < 50) return;   // max ~20 Hz

            last = { vx, vy, sx, grip, pitch };
            lastSend = now;
            socket.emit("control.move", last);
        }

        window.addEventListener("gamepadconnected", e => {
            gpIndex = e.gamepad.index;
            gpStatusEl.innerHTML = `controller: <span class="ok">${e.gamepad.id}</span>`;
        });

        window.addEventListener("gamepaddisconnected", () => {
            gpIndex = null;
            gpStatusEl.innerHTML = `controller: <span class="err">neconectat</span>`;
            sendThrottled();
        });

        function poll() {
            const gps = navigator.getGamepads ? navigator.getGamepads() : [];
            const gp = gpIndex != null ? gps[gpIndex] : null;

            if (gp && gp.connected) {
                const ax0 = dz(gp.axes[0] || 0);
                const ax1 = dz(gp.axes[1] || 0);
                const ax2 = dz(gp.axes[2] || 0);

                vx = clamp(expo(ax0));
                vy = clamp(expo(-ax1));   // înainte pozitiv
                sx = clamp(expo(ax2));

                if (gp.buttons[0]?.pressed) grip = 1; // A
                if (gp.buttons[1]?.pressed) grip = 0; // B
                if (gp.buttons[2]?.pressed) pitch = 1; // X
                else pitch = 0;

                sendThrottled();

                valsEl.textContent =
                    `vx=${vx.toFixed(2)} vy=${vy.toFixed(2)} ` +
                    `sx=${sx.toFixed(2)} grip=${grip}`;

                const angle = Math.atan2(-vy, vx) * 180 / Math.PI - 90;
                arrowEl.style.transform = `rotate(${isNaN(angle) ? 0 : angle}deg)`;
            }

            requestAnimationFrame(poll);
        }

        // pornește loop-ul de gamepad la primul click (cerință pentru browser)
        document.addEventListener("click", function initOnce() {
            document.removeEventListener("click", initOnce);
            requestAnimationFrame(poll);
        });
    </script>
</body>

</html>
